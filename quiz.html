<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIEC AI æ™ºèƒ½æµ‹éªŒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .chat-message {
            animation: slideIn 0.5s ease-out;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .typing-indicator {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
    </style>
</head>
<body class="p-4">
    <div class="max-w-4xl mx-auto">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <div class="glass-card rounded-lg p-4 mb-6 flex items-center justify-between">
            <div class="flex items-center">
                <div class="bg-indigo-600 w-10 h-10 rounded-full flex items-center justify-center mr-3">
                    <i class="fas fa-robot text-white"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-white">AI æ™ºèƒ½æµ‹éªŒåŠ©æ‰‹</h1>
                    <p class="text-gray-200 text-sm">ä¸ªæ€§åŒ–å­¦ä¹ è¯„ä¼°</p>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <a href="index.html" class="bg-white/20 text-white px-4 py-2 rounded-lg hover:bg-white/30 transition-colors">
                    <i class="fas fa-home mr-2"></i>è¿”å›å­¦ä¹ 
                </a>
                <button id="logout-btn" class="bg-red-500/20 text-red-300 px-4 py-2 rounded-lg hover:bg-red-500/30 transition-colors">
                    <i class="fas fa-sign-out-alt mr-2"></i>é€€å‡º
                </button>
            </div>
        </div>

        <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- å·¦ä¾§ï¼šç« èŠ‚é€‰æ‹© -->
            <div class="lg:col-span-1">
                <div class="glass-card rounded-lg p-6">
                    <h2 class="text-lg font-bold text-white mb-4">
                        <i class="fas fa-list-ul mr-2"></i>é€‰æ‹©æµ‹éªŒç« èŠ‚
                    </h2>
                    <div id="chapter-list" class="space-y-2">
                        <!-- ç« èŠ‚åˆ—è¡¨å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šAIå¯¹è¯æµ‹éªŒ -->
            <div class="lg:col-span-2">
                <!-- AIé…ç½®çŠ¶æ€ -->
                <div id="ai-status" class="mb-4 p-4 rounded-lg border glass-card">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <i id="ai-status-icon" class="fas fa-circle text-gray-400 mr-3"></i>
                            <div>
                                <h3 id="ai-status-title" class="font-medium text-white">AIçŠ¶æ€æ£€æŸ¥ä¸­...</h3>
                                <p id="ai-status-desc" class="text-sm text-gray-300 mt-1">æ­£åœ¨æ£€æµ‹AIé…ç½®çŠ¶æ€</p>
                            </div>
                        </div>
                        <a href="ai-config.html" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                            <i class="fas fa-cog mr-2"></i>é…ç½®AI
                        </a>
                    </div>
                </div>
                
                <div class="glass-card rounded-lg p-6 h-[600px] flex flex-col">
                    <!-- å¯¹è¯å†å² -->
                    <div id="chat-history" class="flex-1 overflow-y-auto mb-4 space-y-4">
                        <div class="chat-message bg-blue-500/20 rounded-lg p-4 text-white">
                            <div class="flex items-center mb-2">
                                <i class="fas fa-robot text-blue-300 mr-2"></i>
                                <span class="font-medium">AI åŠ©æ‰‹</span>
                            </div>
                            <p>ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„AIå­¦ä¹ åŠ©æ‰‹ã€‚è¯·é€‰æ‹©ä¸€ä¸ªç« èŠ‚ï¼Œæˆ‘ä¼šä¸ºä½ ç”Ÿæˆä¸ªæ€§åŒ–çš„æµ‹éªŒé¢˜ç›®ã€‚</p>
                        </div>
                    </div>

                    <!-- è¾“å…¥åŒºåŸŸ -->
                    <div class="flex space-x-2">
                        <input 
                            type="text" 
                            id="user-input" 
                            placeholder="è¾“å…¥ä½ çš„ç­”æ¡ˆæˆ–é—®é¢˜..."
                            class="flex-1 px-4 py-2 bg-white/10 rounded-lg text-white placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                            disabled
                        >
                        <button 
                            id="send-btn" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-colors disabled:opacity-50"
                            disabled
                        >
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ç”¨æˆ·éªŒè¯
        const userRole = localStorage.getItem('userRole');
        const username = localStorage.getItem('username');
        
        if (!userRole || !username) {
            alert('è¯·å…ˆç™»å½•ï¼');
            window.location.href = 'login.html';
        }

        // ç« èŠ‚æ•°æ®
        const chapters = [
            { id: 'strategy', title: 'æˆ˜ç•¥è¿›åŒ–è“å›¾', description: 'ä»AIæ•™ç»ƒåˆ°æˆ˜ç•¥å¼•æ“' },
            { id: 'newcomer', title: 'æ–°äººèŒåœºç´ å…»', description: 'å‡¡äº‹æœ‰å›åº”çš„å››ä¸ªå±‚æ¬¡' },
            { id: 'principles', title: 'ç¬¬ä¸€å·¥ä½œåŸåˆ™', description: 'æœºåˆ¶ä¼˜äºæ„æ„¿' },
            { id: 'growth_pillars', title: 'æˆé•¿å››å¤§æ”¯æŸ±', description: 'å››è½®é©±åŠ¨çš„æˆé•¿ç”Ÿæ€' },
            { id: 'growth_model', title: 'å›¢é˜Ÿæˆé•¿æ¨¡å‹', description: 'ä»·å€¼äº¤æ¢ä¸ç¯å¢ƒç­–ç•¥' },
            { id: 'product_dev', title: 'äº§å“å­¦ç§‘åŒ–å»ºè®¾', description: 'æ‹¥æŠ±AIå¢é‡' },
            { id: 'mindset', title: 'ç»„ç»‡å¿ƒæ³•', description: 'åœ¨å˜åŒ–ä¸­ä¿æŒç¨³å®š' }
        ];

        // é¢˜ç›®æ•°æ®åº“ï¼ˆæ¨¡æ‹ŸAIç”Ÿæˆçš„é—®é¢˜ï¼‰
        const questionBank = {
            strategy: [
                {
                    question: "AIECçš„ä¸¤æ¡æ ¸å¿ƒä¸šåŠ¡çº¿æ˜¯ä»€ä¹ˆï¼Ÿå®ƒä»¬ä¹‹é—´çš„å…³ç³»æ˜¯ä»€ä¹ˆï¼Ÿ",
                    type: "essay",
                    points: 10,
                    keywords: ["ç»„ç»‡AIåŒ–", "å•†ä¸šåŒ–", "å†…åŠŸ", "æ±Ÿæ¹–", "äº’ä¸ºå› æœ"]
                },
                {
                    question: "ç»„ç»‡AIåŒ–åŒ…å«å“ªä¸‰ä¸ªå±‚é¢çš„æ·±åº¦èåˆï¼Ÿ",
                    type: "multiple",
                    options: ["ä¸ªä½“AIåŸç”Ÿ", "ååŒAIå¢æ•ˆ", "æµç¨‹AIå˜é©", "äº§å“AIåŒ–"],
                    correct: [0, 1, 2],
                    points: 8
                }
            ],
            newcomer: [
                {
                    question: "\"å‡¡äº‹æœ‰å›åº”\"çš„å››ä¸ªå±‚æ¬¡åˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Ÿè¯·ç®€è¦è¯´æ˜æ¯ä¸ªå±‚æ¬¡çš„ç‰¹ç‚¹ã€‚",
                    type: "essay",
                    points: 12,
                    keywords: ["åŠæ ¼", "ä¼˜ç§€", "ä¸“ä¸š", "å“è¶Š", "åŸºç¡€å“åº”", "ä¸»åŠ¨æ¾„æ¸…", "è¿‡ç¨‹åŒæ­¥", "ç»“æœé—­ç¯"]
                },
                {
                    question: "å½“é¢†å¯¼è¯´\"ä½ çœ‹ç€åŠ\"æ—¶ï¼Œä½ åº”è¯¥å¦‚ä½•å›åº”ï¼Ÿ",
                    type: "single",
                    options: [
                        "ç›´æ¥æŒ‰è‡ªå·±çš„æƒ³æ³•å»åš",
                        "å›å¤\"å¥½çš„ï¼Œæˆ‘çš„ç†è§£æ˜¯[æ–¹æ¡ˆ]ï¼Œå¦‚æœ‰åå·®è¯·å‘ŠçŸ¥\"",
                        "ä»€ä¹ˆéƒ½ä¸è¯´ï¼Œç­‰å¾…è¿›ä¸€æ­¥æŒ‡ç¤º",
                        "è¯¢é—®å…·ä½“åº”è¯¥æ€ä¹ˆåš"
                    ],
                    correct: 1,
                    points: 6
                }
            ],
            principles: [
                {
                    question: "ä¸ºä»€ä¹ˆè¯´\"æœºåˆ¶ä¼˜äºæ„æ„¿\"ï¼Ÿè¯·ä»ç¡®ä¿æˆæœã€æ ¹é™¤å†…è€—ã€å®ç°è§„æ¨¡åŒ–ä¸‰ä¸ªè§’åº¦åˆ†æã€‚",
                    type: "essay",
                    points: 15,
                    keywords: ["ç¡®ä¿æˆæœ", "æ ¹é™¤å†…è€—", "å®ç°è§„æ¨¡åŒ–", "æœºåˆ¶", "æ„æ„¿", "SOP", "è‡ªåŠ¨åŒ–"]
                }
            ],
            growth_pillars: [
                {
                    question: "å›¢é˜Ÿæˆé•¿çš„å››å¤§æ”¯æŸ±åˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Ÿ",
                    type: "multiple",
                    options: ["è´£ä»»é¡¹ç›®", "èµ„æ·±è¾…å¯¼", "AIèµ‹èƒ½", "åŒä¼´å­¦ä¹ ", "ä¸ªäººåŠªåŠ›"],
                    correct: [0, 1, 2, 3],
                    points: 8
                }
            ],
            growth_model: [
                {
                    question: "AIECå›¢é˜Ÿçš„æ ¸å¿ƒå¥‘çº¦æ˜¯ä»€ä¹ˆï¼Ÿ",
                    type: "single",
                    options: ["æ— æ¡ä»¶æœä»", "ä»·å€¼äº¤æ¢", "å‹å¥½åˆä½œ", "å…±åŒæˆé•¿"],
                    correct: 1,
                    points: 5
                }
            ],
            product_dev: [
                {
                    question: "äº§å“å­¦ç§‘åŒ–å»ºè®¾çš„ä¸‰è½´æ‹†è§£æ³•åŒ…æ‹¬å“ªä¸‰ä¸ªè½´ï¼Ÿ",
                    type: "essay",
                    points: 10,
                    keywords: ["æŠ€èƒ½è½´", "å·¥å…·è½´", "åœºæ™¯è½´", "Skill", "Tool", "Scenario"]
                }
            ],
            mindset: [
                {
                    question: "ç»„ç»‡ä¸­å“ªäº›æ˜¯å˜é‡ï¼Œå“ªäº›æ˜¯å¸¸é‡ï¼Ÿä¸ºä»€ä¹ˆè¦è¿™æ ·åŒºåˆ†ï¼Ÿ",
                    type: "essay",
                    points: 12,
                    keywords: ["å˜é‡", "å¸¸é‡", "å›¢é˜Ÿå·¥ä½œæ–¹å¼", "è®¤çŸ¥å†³ç­–", "å¤–éƒ¨ç¯å¢ƒ", "å›¢é˜Ÿå¿ƒæ€", "é¢†å¯¼æ‰¿è¯º"]
                }
            ]
        };

        // å½“å‰æµ‹éªŒçŠ¶æ€
        let currentChapter = null;
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let isQuizActive = false;
        let useRealAI = false;

        // AIé…ç½®ç®¡ç†
        const aiConfig = {
            getConfig: function() {
                return JSON.parse(localStorage.getItem('ai_config') || '{}');
            },
            
            callAI: async function(message) {
                const config = this.getConfig();
                if (!config.apiKey) {
                    throw new Error('AIæœªé…ç½®');
                }
                
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${config.apiKey}`
                    },
                    body: JSON.stringify({
                        model: config.model || 'gpt-3.5-turbo',
                        messages: [
                            {
                                role: 'system',
                                content: 'ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„èŒåœºåŸ¹è®­å¸ˆï¼Œæ“…é•¿æ ¹æ®å­¦ä¹ å†…å®¹ç”Ÿæˆé«˜è´¨é‡çš„æµ‹éªŒé—®é¢˜å¹¶è¯„ä¼°å­¦å‘˜å›ç­”ã€‚è¯·ä»¥å‹å–„ä½†ä¸“ä¸šçš„è¯­æ°”è¿›è¡Œå¯¹è¯ã€‚'
                            },
                            {
                                role: 'user',
                                content: message
                            }
                        ],
                        max_tokens: 1000,
                        temperature: 0.7
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`AIè¯·æ±‚å¤±è´¥: ${response.statusText}`);
                }
                
                const data = await response.json();
                return data.choices[0].message.content;
            }
        };

        // åˆå§‹åŒ–é¡µé¢
        function init() {
            checkAIStatus();
            renderChapterList();
            setupEventListeners();
        }

        // æ£€æŸ¥AIé…ç½®çŠ¶æ€
        function checkAIStatus() {
            const config = aiConfig.getConfig();
            const statusIcon = document.getElementById('ai-status-icon');
            const statusTitle = document.getElementById('ai-status-title');
            const statusDesc = document.getElementById('ai-status-desc');
            
            if (config.apiKey) {
                // æµ‹è¯•AIè¿æ¥
                aiConfig.callAI('æµ‹è¯•è¿æ¥').then(() => {
                    useRealAI = true;
                    statusIcon.className = 'fas fa-check-circle text-green-400 mr-3';
                    statusTitle.textContent = 'AIå·²å¯ç”¨';
                    statusDesc.textContent = 'æ­£åœ¨ä½¿ç”¨çœŸå®AIè¿›è¡Œæ™ºèƒ½æµ‹éªŒ';
                    updateWelcomeMessage(true);
                }).catch(() => {
                    useRealAI = false;
                    statusIcon.className = 'fas fa-exclamation-triangle text-yellow-400 mr-3';
                    statusTitle.textContent = 'AIé…ç½®æœ‰è¯¯';
                    statusDesc.textContent = 'ä½¿ç”¨æ¨¡æ‹ŸAIåŠŸèƒ½ï¼Œç‚¹å‡»å³ä¾§é…ç½®çœŸå®AI';
                    updateWelcomeMessage(false);
                });
            } else {
                useRealAI = false;
                statusIcon.className = 'fas fa-times-circle text-red-400 mr-3';
                statusTitle.textContent = 'AIæœªé…ç½®';
                statusDesc.textContent = 'ä½¿ç”¨æ¨¡æ‹ŸAIåŠŸèƒ½ï¼Œç‚¹å‡»å³ä¾§é…ç½®çœŸå®AIè·å¾—æ›´å¥½ä½“éªŒ';
                updateWelcomeMessage(false);
            }
        }

        // æ›´æ–°æ¬¢è¿æ¶ˆæ¯
        function updateWelcomeMessage(hasAI) {
            const chatHistory = document.getElementById('chat-history');
            const welcomeMessage = chatHistory.querySelector('.chat-message');
            const messageText = welcomeMessage.querySelector('p');
            
            if (hasAI) {
                messageText.textContent = 'ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„AIå­¦ä¹ åŠ©æ‰‹ã€‚è¯·é€‰æ‹©ä¸€ä¸ªç« èŠ‚ï¼Œæˆ‘ä¼šä¸ºä½ ç”Ÿæˆä¸ªæ€§åŒ–çš„æµ‹éªŒé¢˜ç›®å¹¶æä¾›æ™ºèƒ½åé¦ˆã€‚';
            } else {
                messageText.textContent = 'ä½ å¥½ï¼å½“å‰ä½¿ç”¨æ¨¡æ‹ŸAIåŠŸèƒ½ã€‚é…ç½®çœŸå®AIåå¯è·å¾—æ›´æ™ºèƒ½çš„ä¸ªæ€§åŒ–æµ‹éªŒä½“éªŒã€‚è¯·é€‰æ‹©ä¸€ä¸ªç« èŠ‚å¼€å§‹æµ‹éªŒã€‚';
            }
        }

        // æ¸²æŸ“ç« èŠ‚åˆ—è¡¨
        function renderChapterList() {
            const chapterList = document.getElementById('chapter-list');
            chapterList.innerHTML = chapters.map(chapter => `
                <div class="chapter-item p-3 bg-white/10 rounded-lg cursor-pointer hover:bg-white/20 transition-colors" 
                     data-chapter="${chapter.id}">
                    <h3 class="font-medium text-white">${chapter.title}</h3>
                    <p class="text-gray-300 text-sm">${chapter.description}</p>
                </div>
            `).join('');
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // ç« èŠ‚é€‰æ‹©
            document.getElementById('chapter-list').addEventListener('click', (e) => {
                const chapterItem = e.target.closest('.chapter-item');
                if (chapterItem) {
                    const chapterId = chapterItem.dataset.chapter;
                    startQuiz(chapterId);
                }
            });

            // å‘é€æ¶ˆæ¯
            document.getElementById('send-btn').addEventListener('click', sendMessage);
            document.getElementById('user-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            // é€€å‡ºç™»å½•
            document.getElementById('logout-btn').addEventListener('click', () => {
                if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                    localStorage.removeItem('userRole');
                    localStorage.removeItem('username');
                    localStorage.removeItem('loginTime');
                    window.location.href = 'login.html';
                }
            });
        }

        // å¼€å§‹æµ‹éªŒ
        async function startQuiz(chapterId) {
            currentChapter = chapterId;
            currentQuestionIndex = 0;
            userAnswers = [];
            isQuizActive = true;

            // å¯ç”¨è¾“å…¥
            document.getElementById('user-input').disabled = false;
            document.getElementById('send-btn').disabled = false;

            const chapterTitle = chapters.find(c => c.id === chapterId).title;
            const chapterDesc = chapters.find(c => c.id === chapterId).description;

            if (useRealAI) {
                // ä½¿ç”¨çœŸå®AI
                addAIMessage(`å¾ˆå¥½ï¼è®©æˆ‘ä»¬å¼€å§‹ã€Š${chapterTitle}ã€‹çš„æ™ºèƒ½æµ‹éªŒã€‚æˆ‘ä¼šä¸ºä½ ç”Ÿæˆä¸ªæ€§åŒ–çš„é—®é¢˜ã€‚å‡†å¤‡å¥½äº†å—ï¼Ÿ`);
                
                // æ˜¾ç¤ºæ­£åœ¨ç”Ÿæˆæç¤º
                setTimeout(() => {
                    addAIMessage('ğŸ¤– æ­£åœ¨ä¸ºä½ ç”Ÿæˆä¸ªæ€§åŒ–é—®é¢˜...');
                    generateAIQuestions(chapterTitle, chapterDesc);
                }, 1000);
            } else {
                // ä½¿ç”¨é¢„è®¾é¢˜ç›®
                currentQuestions = questionBank[chapterId] || [];
                addAIMessage(`å¾ˆå¥½ï¼è®©æˆ‘ä»¬å¼€å§‹ã€Š${chapterTitle}ã€‹çš„æµ‹éªŒã€‚æˆ‘ä¼šé—®ä½ ${currentQuestions.length}é“é¢˜ã€‚å‡†å¤‡å¥½äº†å—ï¼Ÿ`);
                
                setTimeout(() => {
                    showNextQuestion();
                }, 1000);
            }
        }

        // ä½¿ç”¨AIç”Ÿæˆé—®é¢˜
        async function generateAIQuestions(chapterTitle, chapterDesc) {
            try {
                const prompt = `ä½œä¸ºèŒåœºåŸ¹è®­å¸ˆï¼Œè¯·ä¸ºã€Š${chapterTitle}ã€‹(${chapterDesc})è¿™ä¸ªç« èŠ‚ç”Ÿæˆ3é“æµ‹éªŒé¢˜ã€‚

è¦æ±‚ï¼š
1. é¢˜ç›®è¦èƒ½æ£€éªŒå¯¹æ ¸å¿ƒæ¦‚å¿µçš„æ·±åº¦ç†è§£
2. åŒ…å«ä¸åŒç±»å‹ï¼šé€‰æ‹©é¢˜ã€åˆ¤æ–­é¢˜ã€é—®ç­”é¢˜
3. éš¾åº¦é€‚ä¸­ï¼Œé€‚åˆæ–°å‘˜å·¥
4. è¯·ä¸ºæ¯é“é¢˜æ ‡æ˜é¢˜å‹å’Œåˆ†å€¼

è¯·æŒ‰ä»¥ä¸‹æ ¼å¼ç”Ÿæˆï¼š
ã€é¢˜ç›®1ã€‘(é€‰æ‹©é¢˜/åˆ¤æ–­é¢˜/é—®ç­”é¢˜, Xåˆ†)
é¢˜ç›®å†…å®¹...
å¦‚æœæ˜¯é€‰æ‹©é¢˜ï¼Œè¯·æä¾›é€‰é¡¹Aã€Bã€Cã€D

è¯·å¼€å§‹ç”Ÿæˆé—®é¢˜ï¼š`;

                const response = await aiConfig.callAI(prompt);
                
                // è§£æAIç”Ÿæˆçš„é—®é¢˜å¹¶å¼€å§‹æµ‹éªŒ
                currentQuestions = parseAIQuestions(response);
                addAIMessage(`å¤ªå¥½äº†ï¼æˆ‘ä¸ºä½ ç”Ÿæˆäº†${currentQuestions.length}é“ä¸ªæ€§åŒ–é—®é¢˜ã€‚è®©æˆ‘ä»¬å¼€å§‹å§ï¼`);
                
                setTimeout(() => {
                    showNextQuestion();
                }, 1500);
                
            } catch (error) {
                console.error('AIç”Ÿæˆé—®é¢˜å¤±è´¥:', error);
                addAIMessage('AIç”Ÿæˆé—®é¢˜æ—¶å‡ºç°é”™è¯¯ï¼Œåˆ‡æ¢åˆ°é¢„è®¾é¢˜ç›®æ¨¡å¼ã€‚');
                
                // å›é€€åˆ°é¢„è®¾é¢˜ç›®
                currentQuestions = questionBank[currentChapter] || [];
                setTimeout(() => {
                    showNextQuestion();
                }, 1000);
            }
        }

        // è§£æAIç”Ÿæˆçš„é—®é¢˜
        function parseAIQuestions(aiResponse) {
            // ç®€å•çš„è§£æé€»è¾‘ï¼Œå®é™…é¡¹ç›®ä¸­å¯èƒ½éœ€è¦æ›´å¤æ‚çš„è§£æ
            const questions = [];
            const lines = aiResponse.split('\n');
            let currentQuestion = null;
            
            lines.forEach(line => {
                line = line.trim();
                if (line.includes('ã€é¢˜ç›®') && line.includes('ã€‘')) {
                    if (currentQuestion) {
                        questions.push(currentQuestion);
                    }
                    // è§£æé¢˜ç›®ç±»å‹å’Œåˆ†å€¼
                    const match = line.match(/ã€é¢˜ç›®\d+ã€‘\((.*?),\s*(\d+)åˆ†\)/);
                    const type = match ? match[1] : 'é—®ç­”é¢˜';
                    const points = match ? parseInt(match[2]) : 10;
                    
                    currentQuestion = {
                        question: '',
                        type: type.includes('é€‰æ‹©') ? 'single' : (type.includes('åˆ¤æ–­') ? 'boolean' : 'essay'),
                        points: points,
                        aiGenerated: true,
                        options: [],
                        keywords: []
                    };
                } else if (currentQuestion && line && !line.startsWith('A.') && !line.startsWith('B.') && !line.startsWith('C.') && !line.startsWith('D.')) {
                    if (!currentQuestion.question) {
                        currentQuestion.question = line;
                    }
                } else if (currentQuestion && (line.startsWith('A.') || line.startsWith('B.') || line.startsWith('C.') || line.startsWith('D.'))) {
                    currentQuestion.options.push(line.substring(2).trim());
                }
            });
            
            if (currentQuestion) {
                questions.push(currentQuestion);
            }
            
            return questions.length > 0 ? questions : [
                {
                    question: "è¯·ç”¨ä½ è‡ªå·±çš„è¯æ€»ç»“è¿™ä¸ªç« èŠ‚çš„æ ¸å¿ƒè¦ç‚¹ã€‚",
                    type: "essay",
                    points: 15,
                    aiGenerated: true,
                    keywords: []
                }
            ];
        }

        // æ˜¾ç¤ºä¸‹ä¸€é¢˜
        function showNextQuestion() {
            if (currentQuestionIndex < currentQuestions.length) {
                const question = currentQuestions[currentQuestionIndex];
                let questionText = `**ç¬¬${currentQuestionIndex + 1}é¢˜** (${question.points}åˆ†)\n\n${question.question}`;
                
                if (question.type === 'multiple' || question.type === 'single') {
                    questionText += '\n\né€‰é¡¹ï¼š';
                    question.options.forEach((option, index) => {
                        questionText += `\n${String.fromCharCode(65 + index)}. ${option}`;
                    });
                }
                
                addAIMessage(questionText);
            } else {
                // æµ‹éªŒå®Œæˆ
                finishQuiz();
            }
        }

        // å‘é€æ¶ˆæ¯
        function sendMessage() {
            const input = document.getElementById('user-input');
            const message = input.value.trim();
            
            if (!message) return;

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addUserMessage(message);
            input.value = '';

            if (isQuizActive) {
                // å¤„ç†ç­”æ¡ˆ
                processAnswer(message);
            }
        }

        // å¤„ç†ç­”æ¡ˆ
        async function processAnswer(answer) {
            const question = currentQuestions[currentQuestionIndex];
            
            // æ˜¾ç¤ºæ­£åœ¨è¯„ä¼°æç¤º
            if (useRealAI && question.aiGenerated) {
                addAIMessage('ğŸ¤” æ­£åœ¨è¯„ä¼°ä½ çš„ç­”æ¡ˆ...');
            }
            
            let evaluation;
            if (useRealAI && question.aiGenerated) {
                evaluation = await evaluateWithAI(question, answer);
            } else {
                evaluation = {
                    correct: evaluateAnswer(question, answer),
                    feedback: generateFeedback(question, answer, evaluateAnswer(question, answer))
                };
            }
            
            userAnswers.push({
                question: question.question,
                answer: answer,
                correct: evaluation.correct,
                score: evaluation.score || (evaluation.correct ? question.points : Math.floor(question.points * 0.5)),
                feedback: evaluation.feedback
            });
            
            setTimeout(() => {
                addAIMessage(evaluation.feedback);
                currentQuestionIndex++;
                
                // çŸ­æš‚å»¶è¿Ÿåæ˜¾ç¤ºä¸‹ä¸€é¢˜
                setTimeout(() => {
                    showNextQuestion();
                }, 1500);
            }, 1000);
        }

        // ä½¿ç”¨AIè¯„ä¼°ç­”æ¡ˆ
        async function evaluateWithAI(question, answer) {
            try {
                const prompt = `ä½œä¸ºèŒåœºåŸ¹è®­å¸ˆï¼Œè¯·è¯„ä¼°å­¦å‘˜å¯¹ä»¥ä¸‹é—®é¢˜çš„å›ç­”ï¼š

é—®é¢˜ï¼š${question.question}
å­¦å‘˜å›ç­”ï¼š${answer}

è¯·ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢è¿›è¡Œè¯„ä¼°ï¼š
1. å›ç­”çš„å‡†ç¡®æ€§å’Œå®Œæ•´æ€§
2. æ˜¯å¦æŠ“ä½äº†æ ¸å¿ƒè¦ç‚¹
3. è¡¨è¾¾æ˜¯å¦æ¸…æ™°

è¯·ç»™å‡ºï¼š
- è¯„åˆ†ï¼ˆ0-${question.points}åˆ†ï¼‰
- å…·ä½“çš„åé¦ˆå»ºè®®ï¼ˆé¼“åŠ±æ€§ä½†ä¸“ä¸šï¼‰
- å¦‚æœæœ‰éœ€è¦æ”¹è¿›çš„åœ°æ–¹ï¼Œè¯·æŒ‡å‡º

è¯·ç”¨å‹å–„ä½†ä¸“ä¸šçš„è¯­æ°”å›å¤ï¼Œæ ¼å¼ä¸ºï¼š
è¯„åˆ†ï¼šXåˆ†
åé¦ˆï¼š[å…·ä½“åé¦ˆå†…å®¹]`;

                const response = await aiConfig.callAI(prompt);
                
                // è§£æAIçš„è¯„ä¼°ç»“æœ
                const scoreMatch = response.match(/è¯„åˆ†[ï¼š:]\s*(\d+)/);
                const score = scoreMatch ? parseInt(scoreMatch[1]) : Math.floor(question.points * 0.7);
                const correct = score >= question.points * 0.7; // 70%ä»¥ä¸Šç®—æ­£ç¡®
                
                // æå–åé¦ˆéƒ¨åˆ†
                const feedbackMatch = response.match(/åé¦ˆ[ï¼š:]\s*([\s\S]*)/);
                const feedback = feedbackMatch ? feedbackMatch[1].trim() : response;
                
                return {
                    correct: correct,
                    score: score,
                    feedback: `å¾—åˆ†ï¼š${score}/${question.points}åˆ†\n\n${feedback}`
                };
                
            } catch (error) {
                console.error('AIè¯„ä¼°å¤±è´¥:', error);
                // å›é€€åˆ°ç®€å•è¯„ä¼°
                const simpleCorrect = evaluateAnswer(question, answer);
                return {
                    correct: simpleCorrect,
                    score: simpleCorrect ? question.points : Math.floor(question.points * 0.5),
                    feedback: generateFeedback(question, answer, simpleCorrect) + '\n\n(AIè¯„ä¼°æš‚æ—¶ä¸å¯ç”¨ï¼Œä½¿ç”¨ç®€å•è¯„ä¼°)'
                };
            }
        }

        // è¯„ä¼°ç­”æ¡ˆ
        function evaluateAnswer(question, answer) {
            if (question.type === 'essay') {
                // ç®€å•çš„å…³é”®è¯åŒ¹é…
                const keywords = question.keywords || [];
                const answerLower = answer.toLowerCase();
                const matchCount = keywords.filter(keyword => 
                    answerLower.includes(keyword.toLowerCase())
                ).length;
                return matchCount >= keywords.length * 0.6; // 60%çš„å…³é”®è¯åŒ¹é…
            } else if (question.type === 'single') {
                const answerIndex = answer.toUpperCase().charCodeAt(0) - 65;
                return answerIndex === question.correct;
            } else if (question.type === 'multiple') {
                // ç®€åŒ–å¤„ç†ï¼šæ£€æŸ¥æ˜¯å¦åŒ…å«æ­£ç¡®ç­”æ¡ˆçš„å­—æ¯
                const correctLetters = question.correct.map(i => String.fromCharCode(65 + i));
                return correctLetters.some(letter => answer.toUpperCase().includes(letter));
            }
            return false;
        }

        // ç”Ÿæˆåé¦ˆ
        function generateFeedback(question, answer, isCorrect) {
            const encouragements = [
                "å¾ˆå¥½ï¼", "ä¸é”™ï¼", "æ­£ç¡®ï¼", "å¤ªæ£’äº†ï¼", "ç­”å¾—å¾ˆå¥½ï¼"
            ];
            const corrections = [
                "ç­”æ¡ˆä¸å¤Ÿå®Œæ•´ï¼Œ", "è¿™ä¸ªç­”æ¡ˆéœ€è¦è¡¥å……ï¼Œ", "è®©æˆ‘æ¥å¸®ä½ æ¢³ç†ä¸€ä¸‹ï¼Œ"
            ];

            if (isCorrect) {
                return `${encouragements[Math.floor(Math.random() * encouragements.length)]} ä½ çš„å›ç­”å¾ˆåˆ°ä½ï¼Œå¾—åˆ†ï¼š${question.points}åˆ†`;
            } else {
                return `${corrections[Math.floor(Math.random() * corrections.length)]} ç»§ç»­åŠªåŠ›ï¼å¾—åˆ†ï¼š${Math.floor(question.points * 0.5)}åˆ†`;
            }
        }

        // å®Œæˆæµ‹éªŒ
        function finishQuiz() {
            isQuizActive = false;
            document.getElementById('user-input').disabled = true;
            document.getElementById('send-btn').disabled = true;

            // è®¡ç®—æ€»åˆ†ï¼ˆä¼˜å…ˆä½¿ç”¨AIè¯„ä¼°çš„åˆ†æ•°ï¼‰
            const totalScore = userAnswers.reduce((sum, answer) => {
                return sum + (answer.score || (answer.correct ? currentQuestions[userAnswers.indexOf(answer)].points : Math.floor(currentQuestions[userAnswers.indexOf(answer)].points * 0.5)));
            }, 0);

            const maxScore = currentQuestions.reduce((sum, q) => sum + q.points, 0);
            const percentage = Math.round((totalScore / maxScore) * 100);

            // ä¿å­˜æµ‹éªŒç»“æœ
            saveQuizResult(currentChapter, totalScore, maxScore, percentage);

            // æ˜¾ç¤ºç»“æœ
            const resultMessage = useRealAI ? 
                `ğŸ‰ AIæ™ºèƒ½æµ‹éªŒå®Œæˆï¼\n\nä½ çš„æˆç»©ï¼š${totalScore}/${maxScore}åˆ† (${percentage}%)\n\n${getGradeComment(percentage)}\n\nâœ¨ æœ¬æ¬¡æµ‹éªŒä½¿ç”¨äº†AIæ™ºèƒ½è¯„ä¼°ï¼Œåé¦ˆæ›´åŠ ç²¾å‡†ä¸ªæ€§åŒ–ã€‚\n\nç‚¹å‡»å…¶ä»–ç« èŠ‚ç»§ç»­æµ‹éªŒï¼Œæˆ–è¿”å›å­¦ä¹ é¡µé¢ç»§ç»­å­¦ä¹ ã€‚` :
                `ğŸ‰ æµ‹éªŒå®Œæˆï¼\n\nä½ çš„æˆç»©ï¼š${totalScore}/${maxScore}åˆ† (${percentage}%)\n\n${getGradeComment(percentage)}\n\nğŸ’¡ æç¤ºï¼šé…ç½®AIåå¯è·å¾—æ›´æ™ºèƒ½çš„ä¸ªæ€§åŒ–æµ‹éªŒä½“éªŒã€‚\n\nç‚¹å‡»å…¶ä»–ç« èŠ‚ç»§ç»­æµ‹éªŒï¼Œæˆ–è¿”å›å­¦ä¹ é¡µé¢ç»§ç»­å­¦ä¹ ã€‚`;

            setTimeout(() => {
                addAIMessage(resultMessage);
            }, 1000);
        }

        // è·å–æˆç»©è¯„è¯­
        function getGradeComment(percentage) {
            if (percentage >= 90) return "ğŸŒŸ ä¼˜ç§€ï¼ä½ å¯¹è¿™ä¸ªç« èŠ‚æŒæ¡å¾—å¾ˆå¥½ï¼";
            if (percentage >= 80) return "ğŸ‘ è‰¯å¥½ï¼ç¨åŠ å¤ä¹ å°±èƒ½è¾¾åˆ°ä¼˜ç§€æ°´å¹³ï¼";
            if (percentage >= 70) return "ğŸ“š åŠæ ¼ï¼å»ºè®®é‡æ–°å­¦ä¹ ç›¸å…³å†…å®¹ã€‚";
            return "ğŸ’ª éœ€è¦åŠªåŠ›ï¼è¯·å›åˆ°å­¦ä¹ é¡µé¢é‡æ–°å­¦ä¹ è¿™ä¸ªç« èŠ‚ã€‚";
        }

        // ä¿å­˜æµ‹éªŒç»“æœ
        function saveQuizResult(chapterId, score, maxScore, percentage) {
            const results = JSON.parse(localStorage.getItem(`quiz_results_${username}`) || '{}');
            results[chapterId] = {
                score: score,
                maxScore: maxScore,
                percentage: percentage,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem(`quiz_results_${username}`, JSON.stringify(results));
        }

        // æ·»åŠ AIæ¶ˆæ¯
        function addAIMessage(message) {
            const chatHistory = document.getElementById('chat-history');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message bg-blue-500/20 rounded-lg p-4 text-white';
            messageDiv.innerHTML = `
                <div class="flex items-center mb-2">
                    <i class="fas fa-robot text-blue-300 mr-2"></i>
                    <span class="font-medium">AI åŠ©æ‰‹</span>
                </div>
                <p class="whitespace-pre-line">${message}</p>
            `;
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
        function addUserMessage(message) {
            const chatHistory = document.getElementById('chat-history');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message bg-green-500/20 rounded-lg p-4 text-white ml-8';
            messageDiv.innerHTML = `
                <div class="flex items-center mb-2">
                    <i class="fas fa-user text-green-300 mr-2"></i>
                    <span class="font-medium">${username}</span>
                </div>
                <p class="whitespace-pre-line">${message}</p>
            `;
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        // åˆå§‹åŒ–
        init();
    </script>
</body>
</html> 